<UserControl
    x:Class="Swsu.BattleFieldMonitor.Views.MapContainerView"
    x:ClassModifier="internal"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
    xmlns:views="clr-namespace:Swsu.BattleFieldMonitor.Views"
	xmlns:map="http://www.swsu.ru/schemas/Maps"
	xmlns:viewModels="clr-namespace:Swsu.BattleFieldMonitor.ViewModels.MapContainer"
    xmlns:infrastructure="clr-namespace:Swsu.BattleFieldMonitor.Infrastructure"
	mc:Ignorable="d" 
    DataContext="{infrastructure:UnityResolution ObjectType=viewModels:ViewModel}"
    d:DesignHeight="400"
    d:DesignWidth="600">

    <UserControl.Resources>
		<ResourceDictionary>
			<ResourceDictionary.MergedDictionaries>
				<ResourceDictionary Source="../Resources/CommonResources.xaml"/>
			</ResourceDictionary.MergedDictionaries>

			<map:ToolTemplate2 x:Key="{map:ToolTemplateKey2 DataType={x:Type viewModels:ViewModel}, Qualifier={x:Static viewModels:MapToolMode.Pan}}">
				<map:PanTool2/>
			</map:ToolTemplate2>

            <map:ToolTemplate x:Key="{map:ToolTemplateKey DataType={x:Type viewModels:ViewModel}, Qualifier={x:Static viewModels:MapToolMode.PointDrawing}}">
				<map:PointDrawingTool>
					
				</map:PointDrawingTool>
			</map:ToolTemplate>
		</ResourceDictionary>
	</UserControl.Resources>

	<map:MapViewer ScaleDenominator="{Binding Path=ScaleDenominator, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Tool="{Binding}" ToolTemplateQualifier="{Binding Path=MapToolMode}">
		<map:MapViewer.MapDefinition>
            <!-- Будет заменено привязкой с конвертером. -->
			<map:WmtsMapDefinition
                    Uri="http://10.6.7.179/world_web_merkator/wmts/1.0.0/WMTSCapabilities.xml"
                    LayerIdentifier="world_web_merkator"
                    StyleIdentifier="DefaultStyle"
                    TileMatrixSetIdentifier="world_web_merkator_set"
                    EpsgDataProvider="{StaticResource EpsgDataProvider}" />
		</map:MapViewer.MapDefinition>

        <map:MapLayer ItemsSource="{Binding MapObjects}">
            <map:MapLayer.ItemShapeTemplate>
                <map:ShapeTemplate>
                    <map:CompositeShape >
                        <!--Объект-->
                        <map:CompositeShape>
                            <map:GeographicLineStringShape2 PointsSource="{Binding Coords}">
                                <map:GeographicLineStringShape2.PointContainerStyle>
                                    <Style TargetType="map:GeographicLineStringShapePoint2">
                                        <Setter Property="Latitude" Value="{Binding Latitude}"/>
                                        <Setter Property="Longitude" Value="{Binding Longitude}"/>
                                    </Style>
                                </map:GeographicLineStringShape2.PointContainerStyle>

                                <map:PenCurveSymbol2>
                                    <map:PenCurveSymbol2.Pen>
                                        <Pen Brush="Red" Thickness="1"/>
                                    </map:PenCurveSymbol2.Pen>
                                </map:PenCurveSymbol2>
                            </map:GeographicLineStringShape2>

                            <map:GeographicPointShape2 Latitude="{Binding Latitude}" Longitude="{Binding Longitude}">
                                <!--<map:GeographicPointShape2.Transform>
                                    <RotateTransform Angle="{Binding Azimuth}"/>
                                </map:GeographicPointShape2.Transform>-->

                                <map:GeometryPointSymbol2 Brush="DarkRed">
                                    <map:GeometryPointSymbol2.Pen>
                                        <Pen Brush="DarkRed" Thickness="2"/>
                                    </map:GeometryPointSymbol2.Pen>

                                    <GeometryGroup>
                                        <GeometryGroup.Transform>
                                            <RotateTransform Angle="{Binding Azimuth}"/>
                                        </GeometryGroup.Transform>

                                        <PathGeometry>
                                            <PathFigure IsClosed="True" IsFilled="False" StartPoint="0, -20">
                                                <LineSegment Point="10, -10"/>
                                                <LineSegment Point="10, 20"/>
                                                <LineSegment Point="-10, 20"/>
                                                <LineSegment Point="-10, -10"/>
                                            </PathFigure>
                                        </PathGeometry>

                                        <RectangleGeometry>
                                            <RectangleGeometry.Rect>
                                                <Rect X="-10" Y="12" Width="20" Height="8"/>
                                            </RectangleGeometry.Rect>
                                        </RectangleGeometry>
                                    </GeometryGroup>
                                </map:GeometryPointSymbol2>
                            </map:GeographicPointShape2>
                        </map:CompositeShape>
                        
                        <!--Выноска-->
                        <map:CompositeShape>
                            <map:GeographicPointShape2 Latitude="{Binding Latitude}" Longitude="{Binding Longitude}">
                                <map:GeometryPointSymbol2 Brush="Black" Opacity="0.5">
                                    <RectangleGeometry>
                                        <RectangleGeometry.Rect>
                                            <Rect X="50" Y="-60" Height="120" Width="160"/>
                                        </RectangleGeometry.Rect>
                                    </RectangleGeometry>
                                </map:GeometryPointSymbol2>
                            </map:GeographicPointShape2>

                            <map:GeographicPointShape2 Latitude="{Binding Latitude}" Longitude="{Binding Longitude}">
                                <map:GeometryPointSymbol2>
                                    <map:GeometryPointSymbol2.Pen>
                                        <Pen Brush="White" Thickness="2"/>
                                    </map:GeometryPointSymbol2.Pen>

                                    <PathGeometry>
                                        <PathFigure IsClosed="False" IsFilled="False" StartPoint="30, 0">
                                            <LineSegment Point="50, 0"/>
                                        </PathFigure>

                                        <PathFigure IsClosed="False" IsFilled="False" StartPoint="70, -60">
                                            <LineSegment Point="50, -60"/>
                                            <LineSegment Point="50, 60"/>
                                            <LineSegment Point="70, 60"/>
                                        </PathFigure>

                                        <PathFigure IsClosed="False" IsFilled="False" StartPoint="190, -60">
                                            <LineSegment Point="210, -60"/>
                                            <LineSegment Point="210, 60"/>
                                            <LineSegment Point="190, 60"/>
                                        </PathFigure>
                                    </PathGeometry>
                                </map:GeometryPointSymbol2>
                            </map:GeographicPointShape2>

                            <map:GeographicPointShape2 Latitude="{Binding Latitude}" Longitude="{Binding Longitude}">
                                <map:GeometryPointSymbol2>
                                    <map:GeometryPointSymbol2.Pen>
                                        <Pen Brush="White" Thickness="1"/>
                                    </map:GeometryPointSymbol2.Pen>

                                    <PathGeometry>
                                        <PathFigure IsClosed="False" IsFilled="False" StartPoint="60, 10">
                                            <LineSegment Point="200, 10"/>
                                        </PathFigure>
                                    </PathGeometry>
                                </map:GeometryPointSymbol2>
                            </map:GeographicPointShape2>

                            <map:GeographicPointShape2 Latitude="{Binding Latitude}" Longitude="{Binding Longitude}">
                                <map:GeographicPointShape2.Transform>
                                    <TranslateTransform X="60" Y="-50"/>
                                </map:GeographicPointShape2.Transform>

                                <map:TextPointSymbol2 
                                    Text="{Binding CalloutText}" 
                                    Foreground="White" 
                                    FontWeight="Bold"
                                    FontFamily="Arial">

                                </map:TextPointSymbol2>
                            </map:GeographicPointShape2>
                        </map:CompositeShape>
                    </map:CompositeShape>
                </map:ShapeTemplate>
            </map:MapLayer.ItemShapeTemplate>
        </map:MapLayer>

        <map:MapLayer ItemsSource="{Binding Obstacles}">
            <map:MapLayer.ItemShapeTemplate>
                <map:ShapeTemplate>
                    <map:PolygonShape>
                        <map:PolygonShape.ExternalRing>
                            <map:RingSubshape PointsSource="{Binding Coords}">
                                <map:RingSubshape.PointSubshapeTemplate>
                                    <map:PointSubshapeTemplate>
                                        <map:GeographicPointSubshape 
                                            Latitude="{Binding Latitude}"
                                            Longitude="{Binding Longitude}"/>
                                    </map:PointSubshapeTemplate>
                                </map:RingSubshape.PointSubshapeTemplate>
                            </map:RingSubshape>
                        </map:PolygonShape.ExternalRing>

                        <map:FillPolygonSymbol>
                            <map:FillPolygonSymbol.Fill>
                                <map:FillGroup>
                                    <map:BrushFill>
                                        <SolidColorBrush Color="Red" Opacity="0.5"/>
                                    </map:BrushFill>
                                    <map:StrokeOutlineFill>
                                        <map:PenStroke>
                                            <Pen Brush="Red" Thickness="2"/>
                                        </map:PenStroke>
                                    </map:StrokeOutlineFill>
                                </map:FillGroup>
                            </map:FillPolygonSymbol.Fill>
                        </map:FillPolygonSymbol>
                    </map:PolygonShape>
                </map:ShapeTemplate>
            </map:MapLayer.ItemShapeTemplate>
        </map:MapLayer>
    </map:MapViewer>
</UserControl>
